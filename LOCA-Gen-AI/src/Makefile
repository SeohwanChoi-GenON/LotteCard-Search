# ğŸ¤– LOCA Gen-AI Development & Deployment Makefile
# Spring Boot Profile Style Environment Management

.PHONY: help install dev local staging prod test clean lint format docker health env-info

# ê¸°ë³¸ ì„¤ì •
PYTHON := python3
PIP := pip3
PROJECT_NAME := loca-gen-ai
SRC_DIR := src

# Spring Boot ìŠ¤íƒ€ì¼ í™˜ê²½ ê´€ë¦¬
ENV_DEV := development
ENV_LOCAL := local
ENV_STAGING := staging
ENV_PROD := production

help: ## ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ
	@echo "ğŸ¤– LOCA Gen-AI Development Commands (Spring Boot Profile Style)"
	@echo "=================================================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "ğŸ“¦ Installing dependencies..."
	$(PIP) install -r requirements.txt
	@if [ -f requirements-dev.txt ]; then $(PIP) install -r requirements-dev.txt; fi

# ğŸŒ í™˜ê²½ë³„ ì‹¤í–‰ ëª…ë ¹ì–´ (Spring Boot Profile ìŠ¤íƒ€ì¼)
dev: ## ğŸ”§ ê°œë°œ í™˜ê²½ìœ¼ë¡œ ì„œë²„ ì‹œì‘ (auto-reload)
	@echo "ğŸ”§ Starting development server (auto-reload enabled)..."
	@echo "ğŸ“„ Using profile: $(ENV_DEV)"
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=$(ENV_DEV) $(PYTHON) main.py

local: ## ğŸ  ë¡œì»¬ í™˜ê²½ìœ¼ë¡œ ì„œë²„ ì‹œì‘
	@echo "ğŸ  Starting local server..."
	@echo "ğŸ“„ Using profile: $(ENV_LOCAL)"
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=$(ENV_LOCAL) $(PYTHON) main.py

staging: ## ğŸ­ ìŠ¤í…Œì´ì§• í™˜ê²½ìœ¼ë¡œ ì„œë²„ ì‹œì‘
	@echo "ğŸ­ Starting staging server..."
	@echo "ğŸ“„ Using profile: $(ENV_STAGING)"
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=$(ENV_STAGING) $(PYTHON) main.py

prod: ## ğŸš€ ìš´ì˜ í™˜ê²½ìœ¼ë¡œ ì„œë²„ ì‹œì‘
	@echo "ğŸš€ Starting production server..."
	@echo "ğŸ“„ Using profile: $(ENV_PROD)"
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=$(ENV_PROD) $(PYTHON) main.py

# ğŸ” í™˜ê²½ ì •ë³´
env-info: ## â„¹ï¸ í˜„ì¬ í™˜ê²½ ì„¤ì • ì •ë³´ í‘œì‹œ
	@echo "ğŸ” Environment Information"
	@echo "=========================="
	@echo "ğŸ“‹ Available profiles:"
	@echo "  - development (.env.development)"
	@echo "  - local (.env.local)"
	@echo "  - staging (.env.staging)"
	@echo "  - production (.env.production)"
	@echo ""
	@echo "ğŸ“„ Available environment files:"
	@cd $(SRC_DIR) && find . -name ".env*" -type f | sort
	@echo ""
	@echo "ğŸ”§ Current LOCA_DEPLOYMENT_ENV: $${LOCA_DEPLOYMENT_ENV:-'Not Set (will default to local)'}"

env-setup: ## âš™ï¸ í™˜ê²½ íŒŒì¼ ì´ˆê¸° ì„¤ì •
	@echo "âš™ï¸ Setting up environment files..."
	@cd $(SRC_DIR) && \
	if [ ! -f .env.development ]; then cp .env.example .env.development && echo "âœ… Created .env.development"; fi && \
	if [ ! -f .env.local ]; then cp .env.example .env.local && echo "âœ… Created .env.local"; fi && \
	if [ ! -f .env.staging ]; then cp .env.example .env.staging && echo "âœ… Created .env.staging"; fi && \
	if [ ! -f .env.production ]; then cp .env.example .env.production && echo "âœ… Created .env.production"; fi
	@echo "ğŸ’¡ Please edit the environment files with your specific settings"

env-validate: ## âœ… í™˜ê²½ ì„¤ì • ê²€ì¦
	@echo "âœ… Validating environment configuration..."
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=local $(PYTHON) -c "from configuration import get_loca_config; config = get_loca_config(); print('âœ… Local config validation passed')"
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=development $(PYTHON) -c "from configuration import get_loca_config; config = get_loca_config(); print('âœ… Development config validation passed')"

# ğŸ§ª í…ŒìŠ¤íŠ¸
test: ## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "ğŸ§ª Running tests..."
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=local $(PYTHON) -m pytest tests/ -v

test-cov: ## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì‹¤í–‰
	@echo "ğŸ“Š Running tests with coverage..."
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=local $(PYTHON) -m pytest tests/ --cov=. --cov-report=html --cov-report=term-missing

# ğŸ”§ ì½”ë“œ í’ˆì§ˆ
lint: ## ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
	@echo "ğŸ” Running code quality checks..."
	cd $(SRC_DIR) && $(PYTHON) -m flake8 . || echo "âš ï¸ Flake8 issues found"
	cd $(SRC_DIR) && $(PYTHON) -m pylint **/*.py || echo "âš ï¸ Pylint issues found"

format: ## âœ¨ ì½”ë“œ í¬ë§·íŒ…
	@echo "âœ¨ Formatting code..."
	cd $(SRC_DIR) && $(PYTHON) -m black .
	cd $(SRC_DIR) && $(PYTHON) -m isort .

# ğŸ§¹ ì •ë¦¬
clean: ## ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬
	@echo "ğŸ§¹ Cleaning temporary files..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type d -name "htmlcov" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +

# ğŸ³ Docker (í™˜ê²½ë³„)
docker-build: ## ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(PROJECT_NAME):latest .

docker-dev: ## ğŸ³ Docker ê°œë°œ í™˜ê²½ ì‹¤í–‰
	@echo "ğŸ³ Running Docker in development mode..."
	docker run -p 8000:8000 \
		-v $(PWD)/$(SRC_DIR):/app/$(SRC_DIR) \
		-e LOCA_DEPLOYMENT_ENV=development \
		--env-file $(SRC_DIR)/.env.development \
		$(PROJECT_NAME):latest

docker-prod: ## ğŸ³ Docker ìš´ì˜ í™˜ê²½ ì‹¤í–‰
	@echo "ğŸ³ Running Docker in production mode..."
	docker run -p 8000:8000 \
		-e LOCA_DEPLOYMENT_ENV=production \
		--env-file $(SRC_DIR)/.env.production \
		$(PROJECT_NAME):latest

# ğŸ” ëª¨ë‹ˆí„°ë§
health: ## ğŸ’š ì„œë²„ í—¬ìŠ¤ì²´í¬
	@echo "ğŸ’š Checking server health..."
	curl -f http://localhost:8000/health || echo "âŒ Server is not running"

logs: ## ğŸ“„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸
	@echo "ğŸ“„ Showing application logs..."
	@if [ -f logs/application.log ]; then tail -f logs/application.log; else echo "ğŸ“„ Log file not found"; fi

# ğŸ› ï¸ ê°œë°œ ë„êµ¬
shell: ## ğŸ Python ëŒ€í™”í˜• ì…¸ (ì•± ì»¨í…ìŠ¤íŠ¸)
	@echo "ğŸ Starting Python shell with app context..."
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=local $(PYTHON) -i -c "from main import get_app; app = get_app(); print('ğŸ¤– LOCA App loaded as: app')"

jupyter: ## ğŸ““ Jupyter ë…¸íŠ¸ë¶ ì‹œì‘
	@echo "ğŸ““ Starting Jupyter notebook..."
	cd $(SRC_DIR) && LOCA_DEPLOYMENT_ENV=local jupyter notebook

# ğŸ“¦ ë°°í¬ ê´€ë ¨
deps-check: ## ğŸ“¦ ì˜ì¡´ì„± ìƒíƒœ í™•ì¸
	@echo "ğŸ“¦ Checking dependencies..."
	$(PIP) list --outdated

deps-freeze: ## ğŸ”’ í˜„ì¬ ì˜ì¡´ì„± ê³ ì •
	@echo "ğŸ”’ Freezing current dependencies..."
	$(PIP) freeze > requirements-current.txt

# ğŸš€ ë°°í¬ìš© ëª…ë ¹ì–´ë“¤
deploy-staging: ## ğŸ­ ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
	@echo "ğŸ­ Deploying to staging environment..."
	@echo "âš ï¸ Implement your staging deployment logic here"

deploy-prod: ## ğŸš€ ìš´ì˜ í™˜ê²½ ë°°í¬
	@echo "ğŸš€ Deploying to production environment..."
	@echo "âš ï¸ Implement your production deployment logic here"

# ğŸ“‹ í™˜ê²½ë³„ ë¹ ë¥¸ ëª…ë ¹ì–´
dev-quick: ## âš¡ ê°œë°œ í™˜ê²½ ë¹ ë¥¸ ì‹œì‘ (ì˜ì¡´ì„± ì„¤ì¹˜ + ì„œë²„ ì‹œì‘)
	@make install
	@make dev

reset-env: ## ğŸ”„ í™˜ê²½ ì„¤ì • ì´ˆê¸°í™”
	@echo "ğŸ”„ Resetting environment configuration..."
	cd $(SRC_DIR) && rm -f .env.development .env.local .env.staging .env.production
	@make env-setup

# ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ ì¶œë ¥
examples: ## ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ í‘œì‹œ
	@echo "ğŸ’¡ LOCA Gen-AI Usage Examples (Spring Boot Profile Style)"
	@echo "========================================================"
	@echo ""
	@echo "ğŸ”§ Development (auto-reload):"
	@echo "   make dev"
	@echo "   # or: LOCA_DEPLOYMENT_ENV=development python src/main.py"
	@echo ""
	@echo "ğŸ  Local environment:"
	@echo "   make local"
	@echo "   # or: LOCA_DEPLOYMENT_ENV=local python src/main.py"
	@echo ""
	@echo "ğŸš€ Production:"
	@echo "   make prod"
	@echo "   # or: LOCA_DEPLOYMENT_ENV=production python src/main.py"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "   make docker-build && make docker-dev"
	@echo ""
	@echo "ğŸ” Environment info:"
	@echo "   make env-info"
	@echo ""
	@echo "âš™ï¸ Setup new environment:"
	@echo "   make env-setup"